name: Auto Merge to Main

on:
  push:
    branches:
      - 'claude/**'

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase on main and force push
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Processing branch: $BRANCH_NAME"

          # Fetch latest main
          git fetch origin main

          # Rebase current branch on main
          git rebase origin/main

          # Force push the rebased branch
          git push origin "$BRANCH_NAME" --force-with-lease

      - name: Merge to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Checkout main and merge
          git checkout main
          git pull origin main
          git merge "$BRANCH_NAME" --no-ff -m "Merge $BRANCH_NAME into main"
          git push origin main

          # Delete the feature branch
          git push origin --delete "$BRANCH_NAME" || true

          echo "Successfully merged $BRANCH_NAME into main"
